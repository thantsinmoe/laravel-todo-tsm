name: Phase1 instance deploy by terraform

on:
 push:
    branches:
        - master

env:
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY}}
    SSH_PRIVATE_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64}}

jobs:
 terraform:
    name: Terraform apply EC2
    runs-on: ubuntu-latest

    defaults:
        run:
         working-directory: infra/terraform

    steps:
        - name: Checkout Code
          uses: actions/checkout@v4
        
        - name: Set up Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: 1.6.6

        - name: Terraform Init & Plan
          run: |
            terraform init
            terraform plan
          working-directory: ./infra/terraform

        - name: Terraform Apply
          run: terraform apply -auto-approve
          working-directory: ./infra/terraform

        - name: Show SSH Command Output
          run: terraform output ssh_command
          working-directory: ./infra/terraform

        - name: Decode the private key
          run: |
            echo "${{secrets.SSH_PRIVATE_KEY_BASE64}}" | base64 -d > laravel-key.pem
            chmod 600 laravel-key.pem

        - name: Create ansible inventory
          run: |
            echo "[web]" > inventory.ini
            echo "$(terraform output -raw public_ip) ansible_user=ec2-user ansible_ssh_private_key_file=./laravel-key.pem" >> inventory.ini

        - name: Run Ansible playbook
          run: ansible-playbook -i inventory.ini site.yml
         



    